From: Markus Koschany <apo@debian.org>
Date: Sat, 14 May 2016 20:01:33 +0200
Subject: CVE-2016-4477-part2

Many of the global configuration parameters are written as strings
without filtering and if there is an embedded newline character in the
value, unexpected configuration file data might be written.

This fixes an issue where wpa_supplicant could have updated the
configuration file global parameter with arbitrary data from the control
interface or D-Bus interface. While those interfaces are supposed to be
accessible only for trusted users/applications, it may be possible that
an untrusted user has access to a management software component that
does not validate the value of a parameter before passing it to
wpa_supplicant.

This could allow such an untrusted user to inject almost arbitrary data
into the configuration file. Such configuration file could result in
wpa_supplicant trying to load a library (e.g., opensc_engine_path,
pkcs11_engine_path, pkcs11_module_path, load_dynamic_eap) from user
controlled location when starting again. This would allow code from that
library to be executed under the wpa_supplicant process privileges.

Patch by Jouni Malinen, rebased for Wheezy by Markus Koschany.

Origin: https://w1.fi/security/2016-1/0005-Reject-SET-commands-with-newline-characters-in-the-s.patch
---
 wpa_supplicant/config.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/wpa_supplicant/config.c b/wpa_supplicant/config.c
index 96549d3..8eda6c3 100644
--- a/wpa_supplicant/config.c
+++ b/wpa_supplicant/config.c
@@ -2393,6 +2393,12 @@ static int wpa_global_config_parse_str(const struct global_parse_data *data,
 		return -1;
 	}
 
+	if (has_newline(pos)) {
+		wpa_printf(MSG_ERROR, "Line %d: invalid %s value with newline",
+			   line, data->name);
+		return -1;
+	}
+
 	tmp = os_strdup(pos);
 	if (tmp == NULL)
 		return -1;
