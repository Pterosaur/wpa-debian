From: Markus Koschany <apo@debian.org>
Date: Sat, 14 May 2016 20:20:28 +0200
Subject: CVE-2016-4476 and CVE-2016-4477

Spurious newlines output while writing the config file can corrupt the
wpa_supplicant configuration. Avoid writing these for the network block
parameters. This is a generic filter that cover cases that may not have
been explicitly addressed with a more specific commit to avoid control
characters in the psk parameter.

Patch by Paul Stewart, rebased for Wheezy by Markus Koschany.

Origin: https://w1.fi/security/2016-1/0003-Remove-newlines-from-wpa_supplicant-config-network-o.patch
---
 src/utils/common.c      | 11 +++++++++++
 src/utils/common.h      |  1 +
 wpa_supplicant/config.c | 15 +++++++++++++--
 3 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/src/utils/common.c b/src/utils/common.c
index 38d9129..a121668 100644
--- a/src/utils/common.c
+++ b/src/utils/common.c
@@ -396,3 +396,14 @@ int has_ctrl_char(const u8 *data, size_t len)
     }
     return 0;
 }
+
+int has_newline(const char *str)
+{
+	while (*str) {
+		if (*str == '\n' || *str == '\r')
+			return 1;
+		str++;
+	}
+	return 0;
+}
+
diff --git a/src/utils/common.h b/src/utils/common.h
index 089524a..e8f77bc 100644
--- a/src/utils/common.h
+++ b/src/utils/common.h
@@ -465,6 +465,7 @@ TCHAR * wpa_strdup_tchar(const char *str);
 
 const char * wpa_ssid_txt(const u8 *ssid, size_t ssid_len);
 int has_ctrl_char(const u8 *data, size_t len);
+int has_newline(const char *str);
 
 static inline int is_zero_ether_addr(const u8 *a)
 {
diff --git a/wpa_supplicant/config.c b/wpa_supplicant/config.c
index 8eda6c3..66482d0 100644
--- a/wpa_supplicant/config.c
+++ b/wpa_supplicant/config.c
@@ -2117,8 +2117,19 @@ char * wpa_config_get(struct wpa_ssid *ssid, const char *var)
 
 	for (i = 0; i < NUM_SSID_FIELDS; i++) {
 		const struct parse_data *field = &ssid_fields[i];
-		if (os_strcmp(var, field->name) == 0)
-			return field->writer(field, ssid);
+		if (os_strcmp(var, field->name) == 0) {
+			char *ret = field->writer(field, ssid);
+
+			if (ret && has_newline(ret)) {
+				wpa_printf(MSG_ERROR,
+					   "Found newline in value for %s; not returning it",
+					   var);
+				os_free(ret);
+				ret = NULL;
+			}
+
+			return ret;
+		}
 	}
 
 	return NULL;
